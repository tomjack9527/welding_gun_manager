# views/main_window.py
"""
ä¸»çª—å£è§†å›¾
æ˜¾ç¤ºç„Šæªåˆ—è¡¨ï¼Œå¹¶æä¾›æ·»åŠ æ–°ç„Šæªçš„å…¥å£ã€‚
"""

from views.login_window import LoginWindow
import tkinter as tk
from tkinter import ttk, messagebox
import logging
from controllers.gun_controller import GunController
from controllers.preset_controller import PresetController
from controllers.gun_controller import GunController
from controllers.preset_controller import PresetController
from views.detail_window import DetailWindow  # å¯¼å…¥è¯¦æƒ…çª—å£
from models.entities import WeldingGun # å¯¼å…¥å®ä½“ç±»ï¼Œç”¨äºåˆ›å»ºç©ºå¯¹è±¡

class MainWindow:
    """åº”ç”¨ç¨‹åºçš„ä¸»çª—å£ã€‚"""
    def __init__(self, root):
        self.root = root
        self.logger = logging.getLogger(__name__)
        
        # ====== ã€å…³é”®ã€‘1. åˆå§‹åŒ–æ‰€æœ‰Tkinterå˜é‡ï¼ˆå¿…é¡»åœ¨setup_uiå‰ï¼ï¼‰======
        self.search_var = tk.StringVar()  # æœç´¢æ¡†å˜é‡
    
        # ç­›é€‰æ¡ä»¶å˜é‡ï¼ˆå¸¦é»˜è®¤å€¼"å…¨éƒ¨"ï¼‰
        self.filter_vars = {
            "manufacturers": tk.StringVar(value="å…¨éƒ¨"),
            "gun_types": tk.StringVar(value="å…¨éƒ¨"),
            "lines": tk.StringVar(value="å…¨éƒ¨"),
            "areas": tk.StringVar(value="å…¨éƒ¨")
        }
        
        # å ä½å£°æ˜ï¼ˆsetup_uiä¸­ä¼šå¡«å……ï¼‰
        self.filter_combos = {}  # ç­›é€‰ä¸‹æ‹‰æ¡†å¼•ç”¨å­—å…¸
        self.tree = None         # è¡¨æ ¼å¼•ç”¨
        
        # ====== 2. ç”¨æˆ·æƒé™ç³»ç»Ÿï¼ˆé»˜è®¤administratorï¼‰======
        self.current_user = "administrator"
        self.user_role = "readonly"
        self.user_desc = "åªè¯»ç”¨æˆ·"
        
        # ====== 3. åˆå§‹åŒ–æ§åˆ¶å™¨ ======
        from controllers.gun_controller import GunController
        from controllers.preset_controller import PresetController
        self.controller = GunController()
        self.preset_controller = PresetController()
        
        # ====== 4. åˆ›å»ºUIï¼ˆæ­¤æ—¶æ‰€æœ‰å˜é‡å·²å­˜åœ¨ï¼‰======
        self.setup_ui()
        self._apply_permissions()
        
        # ====== 5. çª—å£é…ç½® ======
        self.root.title("ç„Šæªç®¡ç†ç³»ç»Ÿ - ä¸»é¡µ")
        self.root.geometry("900x600")
        self.root.protocol("WM_DELETE_WINDOW", self._on_closing)
        
    def setup_ui(self):
        """è®¾ç½®ä¸»çª—å£çš„ç”¨æˆ·ç•Œé¢ã€‚"""
        # ====== 1. é¡¶éƒ¨åŒºåŸŸï¼šæœç´¢æ¡† + ç”¨æˆ·çŠ¶æ€æ ï¼ˆåŒè¡Œå¸ƒå±€ï¼‰======
        top_frame = ttk.Frame(self.root)
        top_frame.pack(fill=tk.X, padx=10, pady=5)
    
        # æœç´¢åŒºåŸŸï¼ˆå·¦ä¾§ï¼‰
        search_subframe = ttk.Frame(top_frame)
        search_subframe.pack(side=tk.LEFT, fill=tk.X, expand=True)
        ttk.Label(search_subframe, text="æœç´¢ (åç§°/ç¼–å·):").pack(side=tk.LEFT, padx=(0, 5))
        search_entry = ttk.Entry(
            search_subframe,
            textvariable=self.search_var,
            width=30
        )
        search_entry = ttk.Entry(
            search_subframe,
            textvariable=self.search_var,  # âœ… æ­¤æ—¶å·²å­˜åœ¨
            width=30
        )
        search_entry.bind('<KeyRelease>', lambda e: self.refresh_display())
    
        # ç”¨æˆ·çŠ¶æ€æ ï¼ˆå³ä¾§ï¼‰
        user_bar = ttk.Frame(top_frame)
        user_bar.pack(side=tk.RIGHT, padx=(10, 0))
        self.user_label = ttk.Label(
            user_bar,
            text=f"ğŸ‘¤ {self.current_user} ({self.user_desc})",
            font=("Arial", 9, "bold"),
            foreground="blue" if self.user_role == "admin" else "gray"
        )
        self.user_label.pack(side=tk.LEFT)
        ttk.Button(
            user_bar,
            text="åˆ‡æ¢ç”¨æˆ·",
            command=self._switch_user,
            style="Accent.TButton"
        ).pack(side=tk.LEFT, padx=(5, 0))
        
        # ====== 2. ç­›é€‰åŒºåŸŸï¼ˆå…³é”®ï¼šå¿…é¡»åœ¨æ­¤å¤„åˆ›å»ºå¹¶å¡«å……filter_combosï¼‰======
        filter_frame = ttk.Frame(self.root)
        filter_frame.pack(fill=tk.X, padx=10, pady=(0, 5))
        
        # ã€åŠ å›ºã€‘æ˜¾å¼åˆå§‹åŒ–å­—å…¸ï¼ˆé¿å…æ®‹ç•™ï¼‰
        self.filter_combos = {}
        
        # åˆ›å»ºå››ä¸ªç­›é€‰ä¸‹æ‹‰æ¡†
        filter_configs = [
            ("å“ç‰Œ", "manufacturers"),
            ("æªå‹", "gun_types"),
            ("äº§çº¿", "lines"),
            ("åŒºåŸŸ", "areas")
        ]
        
        for label_text, key in filter_configs:
            frame = ttk.Frame(filter_frame)
            frame.pack(side=tk.LEFT, padx=5)
            ttk.Label(frame, text=f"{label_text}:").pack(side=tk.LEFT)
            combo = ttk.Combobox(
                frame,
                textvariable=self.filter_vars[key],
                width=12,
                state="readonly"  # é˜²æ­¢æ‰‹åŠ¨è¾“å…¥æ— æ•ˆå€¼
            )
            combo.pack(side=tk.LEFT)
            self.filter_combos[key] = combo  # â† ç«‹å³å¡«å……å­—å…¸ï¼
        
        # ====== 3. è¡¨æ ¼åŒºåŸŸ ======
        tree_frame = ttk.Frame(self.root)
        tree_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=(0, 5))
        
        columns = ("id", "name", "manufacturer", "gun_type", "line", "area", "status")
        self.tree = ttk.Treeview(
            tree_frame,
            columns=columns,
            show="headings",
            selectmode="browse"
        )
        
        # åˆ—é…ç½®
        col_names = {
            "id": "ID", "name": "åç§°", "manufacturer": "å“ç‰Œ", "gun_type": "æªå‹",
            "line": "äº§çº¿", "area": "åŒºåŸŸ", "status": "çŠ¶æ€"
        }
        col_widths = {"id": 50, "name": 150, "status": 80}
        
        for col in columns:
            self.tree.heading(col, text=col_names[col])
            self.tree.column(col, width=col_widths.get(col, 100), anchor=tk.CENTER)
        
        # æ»šåŠ¨æ¡
        vsb = ttk.Scrollbar(tree_frame, orient="vertical", command=self.tree.yview)
        hsb = ttk.Scrollbar(tree_frame, orient="horizontal", command=self.tree.xview)
        self.tree.configure(yscrollcommand=vsb.set, xscrollcommand=hsb.set)
        
        self.tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        vsb.pack(side=tk.RIGHT, fill=tk.Y)
        hsb.pack(side=tk.BOTTOM, fill=tk.X)
        
        # ====== 4. ã€å…³é”®ã€‘æ­¤æ—¶è°ƒç”¨load_presetsï¼ˆfilter_comboså·²å¡«å……ï¼‰======
        self.load_presets()
            
            # ====== ã€æ–°å¢ã€‘æƒé™æ§åˆ¶æ ¸å¿ƒæ–¹æ³• ======
        def _switch_user(self):
            """å¼¹å‡ºç™»å½•çª—å£åˆ‡æ¢ç”¨æˆ·"""
            LoginWindow(self.root, self._on_user_login)
        
        def _on_user_login(self, user_id, role, desc):
            """ç™»å½•æˆåŠŸå›è°ƒï¼šæ›´æ–°ç”¨æˆ·çŠ¶æ€å¹¶åˆ·æ–°UI"""
            self.current_user = user_id
            self.user_role = role
            self.user_desc = desc
            self.user_label.config(
                text=f"ğŸ‘¤ {user_id} ({desc})",
                foreground="blue" if role == "admin" else "gray"
            )
            self._apply_permissions()
            self.logger.info(f"ç”¨æˆ·åˆ‡æ¢: {user_id} ({role})")
        
        def _apply_permissions(self):
            """æ ¹æ®æƒé™åŠ¨æ€æ§åˆ¶UIå…ƒç´ """
            # 1. å®‰å…¨ç»‘å®šè¡¨æ ¼äº‹ä»¶ï¼ˆä»…å½“treeå­˜åœ¨æ—¶ï¼‰
            if hasattr(self, 'tree') and self.tree:
                if self.user_role == "readonly":
                    self.tree.unbind('<Double-1>')
                    self.tree.bind('<Double-1>', lambda e: self._show_readonly_tip())
                else:
                    self.tree.unbind('<Double-1>')
                    self.tree.bind('<Double-1>', self._on_double_click)
        
            # 2. å®‰å…¨åˆ·æ–°æ˜¾ç¤ºï¼ˆä»…å½“refresh_displayå­˜åœ¨ä¸”treeå·²åˆå§‹åŒ–ï¼‰
            if hasattr(self, 'refresh_display') and hasattr(self, 'tree') and self.tree:
                try:
                    self.refresh_display()
                except Exception as e:
                    self.logger.warning(f"æƒé™åº”ç”¨æ—¶åˆ·æ–°å¤±è´¥: {e}")
        
            # 3. ã€å¯é€‰ã€‘ç¦ç”¨æ“ä½œæŒ‰é’®ï¼ˆåç»­è¡¥å……æŒ‰é’®å¼•ç”¨åå¯ç”¨ï¼‰
            # if hasattr(self, 'add_btn'): self.add_btn.config(state='normal' if self.user_role=='admin' else 'disabled')
            # 1. è¡¨æ ¼åŒå‡»äº‹ä»¶ï¼šåªè¯»ç”¨æˆ·ç¦ç”¨ç¼–è¾‘
            if hasattr(self, 'tree') and self.tree:
                if self.user_role == "readonly":
                    self.tree.unbind('<Double-1>')  # ç§»é™¤åŒå‡»ç¼–è¾‘
                    self.tree.bind('<Double-1>', lambda e: self._show_readonly_tip())
                else:
                    self.tree.bind('<Double-1>', self._on_double_click)  # æ¢å¤ç¼–è¾‘
            
            # 2. ç¦ç”¨/å¯ç”¨æ“ä½œæŒ‰é’®ï¼ˆéœ€åœ¨setup_uiä¸­ä¿å­˜æŒ‰é’®å¼•ç”¨ï¼‰
            # ç¤ºä¾‹ï¼šå‡è®¾ä½ æœ‰ self.add_btn, self.del_btn ç­‰
            # if hasattr(self, 'add_btn'): self.add_btn.config(state='normal' if self.user_role=='admin' else 'disabled')
            
            # 3. åˆ·æ–°æ˜¾ç¤ºï¼ˆç¡®ä¿ç­›é€‰ç­‰é€»è¾‘ä¸å—å½±å“ï¼‰
            if hasattr(self, 'refresh_display'):
                self.refresh_display()
        
        def _show_readonly_tip(self):
            """åªè¯»ç”¨æˆ·å°è¯•ç¼–è¾‘æ—¶çš„æç¤º"""
            from tkinter import messagebox
            messagebox.showinfo("æƒé™æç¤º", "å½“å‰ç”¨æˆ·æ— ç¼–è¾‘æƒé™ï¼\nè¯·åˆ‡æ¢è‡³ system è´¦æˆ·ï¼ˆå¯†ç : managerï¼‰è¿›è¡Œæ“ä½œã€‚", parent=self.root)
        
        # ====== ã€å¢å¼ºã€‘åŸæœ‰åŒå‡»äº‹ä»¶ï¼ˆå¢åŠ æƒé™æ£€æŸ¥ï¼‰======
        def _on_double_click(self, event):
            """è¡¨æ ¼åŒå‡»äº‹ä»¶ï¼ˆå®‰å…¨å…¥å£ï¼‰"""
            if self.user_role == "readonly":
                self._show_readonly_tip()
                return
            # ... [åŸæœ‰æ‰“å¼€DetailWindowçš„é€»è¾‘] ...
            
            ttk.Button(
                user_bar, 
                text="åˆ‡æ¢ç”¨æˆ·", 
                command=self._switch_user,
                style="Accent.TButton"  # å¯é€‰ï¼šæ·»åŠ é†’ç›®æ ·å¼
            ).pack(side=tk.LEFT)
            
            ttk.Label(self.search_frame, text="æœç´¢ (åç§°/ç¼–å·):").pack(side=tk.LEFT, padx=(0, 5))
            search_entry = ttk.Entry(
                self.search_frame, 
                textvariable=self.search_var,  # âœ… ä½¿ç”¨__init__ä¸­å·²åˆå§‹åŒ–çš„å˜é‡
                width=30
            )
            search_entry.pack(side=tk.LEFT, padx=(0, 10), fill=tk.X, expand=True)
            search_entry.bind('<KeyRelease>', lambda event: self.refresh_display())
            
            # --- ç­›é€‰åŒºåŸŸï¼ˆç¤ºä¾‹ï¼šå“ç‰Œç­›é€‰ï¼‰---
            filter_frame = ttk.Frame(self.root)
            filter_frame.pack(pady=5, padx=10, fill=tk.X)
            
            # åˆ›å»ºç­›é€‰ä¸‹æ‹‰æ¡†ï¼ˆå…³é”®ï¼šä¿å­˜å¼•ç”¨åˆ°self.filter_combosï¼‰
            for label, key in [("å“ç‰Œ", "manufacturers"), ("æªå‹", "gun_types"), 
                            ("äº§çº¿", "lines"), ("åŒºåŸŸ", "areas")]:
                frame = ttk.Frame(filter_frame)
                frame.pack(side=tk.LEFT, padx=5)
                ttk.Label(frame, text=f"{label}:").pack(side=tk.LEFT)
                combo = ttk.Combobox(frame, textvariable=self.filter_vars[key], width=12)
                combo.pack(side=tk.LEFT)
                self.filter_combos[key] = combo  # âœ… ä¿å­˜å¼•ç”¨ï¼ˆä¾›load_presetsæ›´æ–°ï¼‰
            
            # --- è¡¨æ ¼åŒºåŸŸï¼ˆåç»­å®ç°ï¼‰---
            # tree_frame = ... 
            # self.tree = ttk.Treeview(...)
            
            # --- åˆå§‹åŒ–é¢„è®¾æ•°æ®ï¼ˆå…³é”®ï¼ï¼‰---
            self.load_presets()  # ç¡®ä¿ä¸‹æ‹‰æ¡†æœ‰æ•°æ®
        
        def load_presets(self):
            """åŠ è½½é¢„è®¾æ•°æ®åˆ°ç­›é€‰ä¸‹æ‹‰æ¡†"""
            # ä»PresetControllerè·å–é¢„è®¾
            self.presets = self.preset_controller.get_all_presets()
            
            # æ›´æ–°æ‰€æœ‰ç­›é€‰ä¸‹æ‹‰æ¡†
            for key, combo in self.filter_combos.items():
                options = ["å…¨éƒ¨"] + self.presets.get(key, [])
                combo['values'] = options
                # ä¿æŒå½“å‰é€‰ä¸­å€¼ï¼ˆè‹¥å­˜åœ¨ï¼‰
                current = self.filter_vars[key].get()
                if current in options:
                    combo.set(current)

            # ç­›é€‰ä¸‹æ‹‰èœå•
            # --- ä¿®æ­£: ä½¿ç”¨ filter_vars çš„é”® ---
            for key, var in self.filter_vars.items():
                # æ˜ å°„é”®ååˆ°æ˜¾ç¤ºæ–‡æœ¬
                display_name_map = {
                    'manufacturers': 'å“ç‰Œ',
                    'gun_types': 'ç±»å‹',
                    'lines': 'çº¿ä½“',
                    'areas': 'åŒºåŸŸ',
                }
                display_name = display_name_map.get(key, key.capitalize()) # å¦‚æœæ²¡æ‰¾åˆ°æ˜ å°„ï¼Œå°±ç”¨é¦–å­—æ¯å¤§å†™

                ttk.Label(self.search_frame, text=f"{display_name}:").pack(side=tk.LEFT, padx=(10, 5))
                combo = ttk.Combobox(self.search_frame, textvariable=var, state="readonly", width=12)
                combo['values'] = ('å…¨éƒ¨',) # åˆå§‹å€¼
                combo.pack(side=tk.LEFT, padx=(0, 10))
                combo.bind('<<ComboboxSelected>>', lambda event: self.refresh_display())
                # --- å­˜å‚¨ Combobox å¼•ç”¨ ---
                self.filter_combos[key] = combo

            # --- æŒ‰é’®åŒºåŸŸ ---
            button_frame = ttk.Frame(self.root)
            button_frame.pack(pady=5, padx=10, fill=tk.X)

            ttk.Button(button_frame, text="æ·»åŠ æ–°ç„Šæª", command=self.open_add_window).pack(side=tk.LEFT, padx=(0, 5))
            ttk.Button(button_frame, text="åˆ·æ–°åˆ—è¡¨", command=self.refresh_display).pack(side=tk.LEFT, padx=(0, 5))

            # --- è¡¨æ ¼åŒºåŸŸ ---
            columns = ("ID", "åç§°", "å“ç‰Œ", "ç±»å‹", "çº¿ä½“", "åŒºåŸŸ", "æœºå™¨äººå·")
            self.tree = ttk.Treeview(self.root, columns=columns, show='headings', height=15)

            # å®šä¹‰åˆ—æ ‡é¢˜å’Œå®½åº¦
            column_widths = {
                "ID": 50, "åç§°": 150, "å“ç‰Œ": 100, "ç±»å‹": 120, "çº¿ä½“": 80, "åŒºåŸŸ": 100, "æœºå™¨äººå·": 80
            }
            for col in columns:
                self.tree.heading(col, text=col)
                self.tree.column(col, width=column_widths.get(col, 100), anchor=tk.W)

            # æ·»åŠ æ»šåŠ¨æ¡
            tree_scroll_y = ttk.Scrollbar(self.root, orient=tk.VERTICAL, command=self.tree.yview)
            tree_scroll_x = ttk.Scrollbar(self.root, orient=tk.HORIZONTAL, command=self.tree.xview)
            self.tree.configure(yscrollcommand=tree_scroll_y.set, xscrollcommand=tree_scroll_x.set)

            self.tree.pack(pady=10, padx=10, fill=tk.BOTH, expand=True)
            tree_scroll_y.pack(side=tk.RIGHT, fill=tk.Y)
            tree_scroll_x.pack(side=tk.BOTTOM, fill=tk.X)

            # ç»‘å®šåŒå‡»äº‹ä»¶ä»¥ç¼–è¾‘
            self.tree.bind("<Double-1>", self.on_item_double_click)

            # åˆå§‹åŠ è½½æ•°æ®
            self.load_presets()
            self.refresh_display()

        def load_presets(self):
            """ä»æ§åˆ¶å™¨åŠ è½½æ‰€æœ‰é¢„è®¾é€‰é¡¹ï¼Œç”¨äºç­›é€‰ä¸‹æ‹‰èœå•ã€‚"""
            self.presets = PresetController.get_all_presets()
            # --- ä¿®æ­£: éå† filter_combosï¼Œè€Œä¸æ˜¯ presets ---
            # è¿™æ ·å¯ä»¥ç¡®ä¿åªæ›´æ–°å­˜åœ¨çš„ Combobox
            for key, combo_widget in self.filter_combos.items():
                # è·å–ä¸å½“å‰ Combobox å¯¹åº”çš„é¢„è®¾å€¼
                values = self.presets.get(key, []) # ä½¿ç”¨ .get() é¿å… KeyError
                if values:
                    combo_widget['values'] = ('å…¨éƒ¨',) + tuple(sorted(values, key=str.lower))
                else:
                    combo_widget['values'] = ('å…¨éƒ¨',) # å¦‚æœæ²¡æœ‰é¢„è®¾å€¼ï¼Œåªæ˜¾ç¤ºâ€œå…¨éƒ¨â€

        def refresh_display(self):
            """åˆ·æ–°è¡¨æ ¼æ˜¾ç¤ºï¼Œåº”ç”¨æœç´¢å’Œç­›é€‰æ¡ä»¶ã€‚"""
            # æ¸…ç©ºå½“å‰è¡¨æ ¼å†…å®¹
            for item in self.tree.get_children():
                self.tree.delete(item)

            # è·å–æœç´¢å’Œç­›é€‰æ¡ä»¶
            search_term = self.search_var.get().strip().lower()
            filters = {}
            for key, var in self.filter_vars.items():
                val = var.get()
                if val != "å…¨éƒ¨":
                    filters[key] = val # ä½¿ç”¨æ­£ç¡®çš„é”®å (manufacturers, gun_types, etc.)

            # ä»æ§åˆ¶å™¨è·å–æ•°æ®
            all_guns = self.controller.load_all_guns()

            # åº”ç”¨æœç´¢å’Œç­›é€‰
            filtered_guns = []
            for gun in all_guns:
                # --- ä¿®æ­£: ä½¿ç”¨æ­£ç¡®çš„å±æ€§åè¿›è¡Œç­›é€‰ ---
                # è¿™é‡Œå‡è®¾ WeldingGun å®ä½“ç±»æœ‰å¯¹åº”çš„å±æ€§
                # ä¾‹å¦‚: gun.manufacturer å¯¹åº” filters['manufacturers']
                # éœ€è¦ç¡®ä¿ WeldingGun å®ä½“å’Œæ•°æ®åº“å­—æ®µä¸€è‡´
                match_search = not search_term or search_term in gun.name.lower() or search_term in gun.gun_number.lower()
                
                match_filters = True
                for filter_key, filter_value in filters.items():
                    # æ˜ å°„ filter_key åˆ° WeldingGun çš„å±æ€§å
                    # ä¾‹å¦‚ 'manufacturers' -> 'manufacturer'
                    attr_name_map = {
                        'manufacturers': 'manufacturer',
                        'gun_types': 'gun_type',
                        'lines': 'line',
                        'areas': 'area',
                    }
                    gun_attr_name = attr_name_map.get(filter_key)
                    
                    if gun_attr_name:
                        gun_attr_value = getattr(gun, gun_attr_name, None)
                        if gun_attr_value != filter_value:
                            match_filters = False
                            break
                if match_search and match_filters:
                    filtered_guns.append(gun)

            # æ’å…¥æ•°æ®åˆ°è¡¨æ ¼
            for gun in filtered_guns:
                # --- ä¿®æ­£: ä½¿ç”¨æ­£ç¡®çš„å±æ€§åå¡«å……è¡¨æ ¼ ---
                # ä¾‹å¦‚: gun.manufacturer å¯¹åº”è¡¨æ ¼çš„ "å“ç‰Œ" åˆ—
                self.tree.insert('', tk.END, values=(
                    gun.id, gun.name, gun.manufacturer, gun.gun_type, # ä½¿ç”¨ manufacturer, gun_type
                    gun.line, gun.area, gun.robot_number
                ))

        def open_add_window(self):
            """æ‰“å¼€æ·»åŠ æ–°ç„Šæªçš„è¯¦æƒ…çª—å£ã€‚"""
            # åˆ›å»ºä¸€ä¸ªç©ºçš„ WeldingGun å¯¹è±¡ä½œä¸ºåˆå§‹æ•°æ®
            initial_data = WeldingGun()
            # initial_data.presets = self.presets # å¦‚æœ detail_window éœ€è¦ï¼Œå¯ä»¥é€šè¿‡æ„é€ å‡½æ•°ä¼ é€’
            detail_window = DetailWindow(tk.Toplevel(self.root), self.controller, initial_data, mode='add', presets=self.presets)
            # å¯ä»¥é€‰æ‹©ç­‰å¾…çª—å£å…³é—­åå†åˆ·æ–°ä¸»åˆ—è¡¨
            # detail_window.window.wait_window() # è¿™ä¼šè®©ä¸»çº¿ç¨‹é˜»å¡
            # self.refresh_display() # çª—å£å…³é—­ååˆ·æ–°
            # æˆ–è€…ï¼Œåœ¨ DetailWindow å†…éƒ¨æˆåŠŸä¿å­˜åå‘é€ä¿¡å·ç»™ä¸»çª—å£åˆ·æ–°ï¼Œæ›´æ¨è

        def on_item_double_click(self, event):
            """å¤„ç†è¡¨æ ¼é¡¹åŒå‡»äº‹ä»¶ï¼Œæ‰“å¼€ç¼–è¾‘çª—å£ã€‚"""
            selected_item = self.tree.selection()
            if not selected_item:
                return

            item_values = self.tree.item(selected_item, 'values')
            if not item_values:
                return

            gun_id = int(item_values[0]) # ID æ˜¯ç¬¬ä¸€ä¸ªå€¼
            gun_to_edit = self.controller.get_gun_by_id(gun_id)
            if gun_to_edit:
                detail_window = DetailWindow(tk.Toplevel(self.root), self.controller, gun_to_edit, mode='edit', presets=self.presets)
                # åŒæ ·ï¼Œå¯ä»¥åœ¨ä¿å­˜ååˆ·æ–°ä¸»åˆ—è¡¨
        def _on_double_click(self, event):
            """åŒå‡»è¡¨æ ¼è¡Œï¼ˆæƒé™æ£€æŸ¥å·²åœ¨_apply_permissionsä¸­å¤„ç†ï¼‰"""
            if not self.tree.selection():
                return
            # åç»­å®ç°ï¼šè·å–é€‰ä¸­é¡¹ â†’ æ‰“å¼€DetailWindowç¼–è¾‘
            self.logger.info("åŒå‡»äº‹ä»¶è§¦å‘ï¼ˆå¾…å®ç°DetailWindowï¼‰")

        def _show_readonly_tip(self):
            """åªè¯»ç”¨æˆ·æç¤º"""
            from tkinter import messagebox
            messagebox.showinfo(
                "æƒé™æç¤º", 
                "å½“å‰ç”¨æˆ·æ— ç¼–è¾‘æƒé™ï¼\nè¯·åˆ‡æ¢è‡³ system è´¦æˆ·ï¼ˆå¯†ç : managerï¼‰è¿›è¡Œæ“ä½œã€‚",
                parent=self.root
            )
        # views/main_window.py - è¡¥å……ç¼ºå¤±æ–¹æ³•ï¼ˆé˜²å´©æºƒï¼‰
        
        def _switch_user(self):
            """å¼¹å‡ºç™»å½•çª—å£åˆ‡æ¢ç”¨æˆ·"""
            from views.login_window import LoginWindow
            LoginWindow(self.root, self._on_user_login)

        def _on_user_login(self, user_id, role, desc):
            """ç™»å½•æˆåŠŸå›è°ƒ"""
            self.current_user = user_id
            self.user_role = role
            self.user_desc = desc
            self.user_label.config(
                text=f"ğŸ‘¤ {user_id} ({desc})",
                foreground="blue" if role == "admin" else "gray"
            )
            self._apply_permissions()
            self.logger.info(f"ç”¨æˆ·åˆ‡æ¢: {user_id} ({role})")

        def refresh_display(self):
            """åˆ·æ–°è¡¨æ ¼æ˜¾ç¤ºï¼ˆç©ºå®ç°é˜²å´©æºƒï¼Œåç»­è¡¥å……ï¼‰"""
            if not hasattr(self, 'tree') or not self.tree:
                return
            # TODO: åç»­å®ç°ï¼šæ ¹æ®æœç´¢/ç­›é€‰æ¡ä»¶åŠ è½½æ•°æ®
            for item in self.tree.get_children():
                self.tree.delete(item)
            # ç¤ºä¾‹ï¼šæ·»åŠ ç©ºæç¤ºè¡Œ
            self.tree.insert("", "end", values=("", "æš‚æ— æ•°æ®", "", "", "", "", ""))
            
            # ====== ã€æƒé™ç³»ç»Ÿæ ¸å¿ƒæ–¹æ³• - å¿…é¡»ç¼©è¿›åœ¨ç±»å†…ã€‘======
            def _switch_user(self):
                from views.login_window import LoginWindow
                LoginWindow(self.root, self._on_user_login)

            def _on_user_login(self, user_id, role, desc):
                self.current_user = user_id
                self.user_role = role
                self.user_desc = desc
                self.user_label.config(
                    text=f"ğŸ‘¤ {user_id} ({desc})",
                    foreground="blue" if role == "admin" else "gray"
                )
                self._apply_permissions()
                self.logger.info(f"ç”¨æˆ·åˆ‡æ¢: {user_id} ({role})")

            def _apply_permissions(self):
                if hasattr(self, 'tree') and self.tree:
                    self.tree.unbind('<Double-1>')
                    if self.user_role == "readonly":
                        self.tree.bind('<Double-1>', lambda e: self._show_readonly_tip())
                    else:
                        self.tree.bind('<Double-1>', self._on_double_click)
                if hasattr(self, 'refresh_display'):
                    self.refresh_display()

            def _show_readonly_tip(self):
                from tkinter import messagebox
                messagebox.showinfo("æƒé™æç¤º", "å½“å‰ç”¨æˆ·æ— ç¼–è¾‘æƒé™ï¼\nè¯·åˆ‡æ¢è‡³ system è´¦æˆ·ï¼ˆå¯†ç : managerï¼‰è¿›è¡Œæ“ä½œã€‚", parent=self.root)

            def _on_double_click(self, event):
                if self.tree.selection():
                    self.logger.info("åŒå‡»äº‹ä»¶è§¦å‘ï¼ˆDetailWindowå¾…å®ç°ï¼‰")

            def refresh_display(self):
                if not (hasattr(self, 'tree') and self.tree):
                    return
                for item in self.tree.get_children():
                    self.tree.delete(item)
                self.tree.insert("", "end", values=("", "â— ç³»ç»Ÿå°±ç»ªï¼šç‚¹å‡»'åˆ‡æ¢ç”¨æˆ·'ç™»å½• system è´¦æˆ·è¿›è¡Œæ“ä½œ â—", "", "", "", "", ""))
                    
# --- ç¤ºä¾‹ç”¨æ³• ---
if __name__ == "__main__":
    root = tk.Tk()
    app = MainWindow(root)
    root.mainloop()